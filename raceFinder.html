<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Finder — Plan Your Run</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="./pyr.css">
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-50 min-h-screen" x-data="raceFinder()" x-init="init()" x-cloak>

<!-- Page loading overlay -->
<div id="app-loader" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:#f8fafc;">
    <div style="width:44px;height:44px;border:4px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:pyr-spin 0.7s linear infinite;"></div>
</div>
<style>@keyframes pyr-spin { to { transform: rotate(360deg); } }</style>

<!-- Nav -->
<nav class="w-full bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between shadow-sm sticky top-0 z-40">
    <a href="./index.html" class="flex items-center gap-2.5 no-underline"></a>
    <div class="flex items-center gap-4">
        <div x-show="isLoggedIn" x-cloak
            class="h-7 w-7 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold"
            x-text="userInitial" title="Signed in"></div>
    </div>
</nav>

<!-- Page header -->
<div class="bg-white border-b border-gray-100 px-6 py-5">
    <h1 class="text-xl font-bold text-gray-900">Race Finder</h1>
    <p class="text-sm text-gray-500 mt-0.5">Search thousands of races, then build your training plan in one click.</p>
</div>

<!-- Main layout -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 py-6">
    <div class="lg:grid lg:gap-6" style="grid-template-columns: 300px 1fr;">

        <!-- ── Filters sidebar ── -->
        <aside class="mb-6 lg:mb-0">
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">

                <!--
                AI search — commented out, not worth maintaining right now
                <details class="border-b border-gray-100" open>
                    <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none hover:bg-gray-50" style="list-style:none;">
                        <div class="flex items-center gap-2">
                            <svg class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.347.347a3.5 3.5 0 01-.5.364V19a2 2 0 11-4 0v-1.15a3.5 3.5 0 01-.5-.364l-.347-.347z" />
                            </svg>
                            <span class="text-sm font-semibold text-gray-700">AI Search</span>
                            <span class="text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full font-medium">Beta</span>
                        </div>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </summary>
                    <div class="px-4 pb-4 pt-2 space-y-3">
                        <template x-if="!isLoggedIn">
                            <div class="rounded-lg bg-blue-50 border border-blue-100 px-3 py-2.5 text-xs text-blue-700">
                                <a href="./index.html" class="font-semibold underline">Sign in</a> to use AI-powered race search.
                            </div>
                        </template>
                        <template x-if="isLoggedIn">
                            <div class="space-y-2">
                                <p class="text-xs text-gray-500">Describe the race you're looking for in plain English.</p>
                                <textarea x-model="aiQuery"
                                    class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
                                    rows="3"
                                    placeholder="e.g. Find me a half marathon near Boston this fall…"></textarea>
                                <button @click="askAI()"
                                    :disabled="aiLoading"
                                    class="w-full rounded-lg bg-blue-600 px-3 py-2 text-sm font-medium text-white hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center justify-center gap-2">
                                    <svg x-show="aiLoading" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                    <span x-text="aiLoading ? 'Thinking…' : 'Search with AI'"></span>
                                </button>
                                <p x-show="aiError" class="text-xs text-red-500" x-text="aiError"></p>
                                <div x-show="aiSummary"
                                    class="rounded-lg bg-gray-50 border border-gray-200 px-3 py-2.5 text-xs text-gray-600 leading-relaxed"
                                    x-text="aiSummary"></div>
                            </div>
                        </template>
                    </div>
                </details>
                -->

                <!-- Manual filters -->
                <div class="px-4 py-4 space-y-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Filters</p>

                    <!-- Zip + radius -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Zip Code <span class="text-red-400">*</span></label>
                            <input type="text" x-model="zip" placeholder="10001"
                                @keydown.enter="search()"
                                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Radius (mi)</label>
                            <input type="number" x-model="radius" min="1" max="500"
                                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Date range -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">From</label>
                            <input type="date" x-model="startDate"
                                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">To</label>
                            <input type="date" x-model="endDate"
                                class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Distance presets -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-2">Distance</label>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="p in presets" :key="p.key">
                                <button @click="setPreset(p.key)"
                                    :class="selectedPreset === p.key
                                        ? 'bg-blue-600 text-white border-blue-600'
                                        : 'bg-white text-gray-700 border-gray-200 hover:border-blue-400 hover:text-blue-600'"
                                    class="rounded-full border px-3 py-1 text-xs font-medium transition-colors"
                                    x-text="p.label">
                                </button>
                            </template>
                            <button x-show="selectedPreset" @click="clearPreset()"
                                class="rounded-full border border-gray-200 bg-white text-gray-400 hover:text-red-500 hover:border-red-300 px-3 py-1 text-xs transition-colors">
                                Clear
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Min (<span x-text="units"></span>)</label>
                                <input type="number" x-model="minDistance" min="0" step="0.1"
                                    class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Max (<span x-text="units"></span>)</label>
                                <input type="number" x-model="maxDistance" min="0" step="0.1"
                                    class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                            </div>
                        </div>
                        <div class="mt-2 flex items-center gap-3">
                            <span class="text-xs text-gray-500">Units:</span>
                            <label class="flex items-center gap-1 text-xs text-gray-600 cursor-pointer">
                                <input type="radio" x-model="units" value="K" class="accent-blue-600"> km
                            </label>
                            <label class="flex items-center gap-1 text-xs text-gray-600 cursor-pointer">
                                <input type="radio" x-model="units" value="M" class="accent-blue-600"> miles
                            </label>
                        </div>
                    </div>

                    <!-- Keyword -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Keyword</label>
                        <input type="text" x-model="keyword" placeholder="trail, flat, BQ…"
                            @keydown.enter="search()"
                            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                    </div>

                    <!-- Sort -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Sort by</label>
                        <select x-model="sort"
                            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white">
                            <option value="next_date_local">Race Date (soonest first)</option>
                            <option value="name">Name (A → Z)</option>
                            <option value="city">City</option>
                            <option value="state">State</option>
                            <option value="created">Recently Added</option>
                        </select>
                    </div>

                    <!-- Search button -->
                    <button @click="search()"
                        :disabled="isLoading"
                        class="w-full rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center justify-center gap-2">
                        <svg x-show="isLoading" class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        <span x-text="isLoading ? 'Searching…' : 'Search Races'"></span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ── Results panel ── -->
        <main>
            <!-- Error banner -->
            <div x-show="error" x-cloak
                class="rounded-xl bg-red-50 border border-red-200 px-4 py-3 mb-4 text-sm text-red-700"
                x-text="error"></div>

            <!-- Loading skeletons -->
            <div x-show="isLoading" class="grid sm:grid-cols-2 gap-4">
                <template x-for="i in [1,2,3,4,5,6]" :key="i">
                    <div class="bg-white rounded-xl border border-gray-200 p-4 animate-pulse">
                        <div class="flex gap-3">
                            <div class="w-14 h-14 bg-gray-100 rounded-lg flex-shrink-0"></div>
                            <div class="flex-1 space-y-2 pt-1">
                                <div class="h-3.5 bg-gray-100 rounded w-3/4"></div>
                                <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                                <div class="h-3 bg-gray-100 rounded w-1/3"></div>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                            <div class="flex-1 h-8 bg-gray-100 rounded-lg"></div>
                            <div class="flex-1 h-8 bg-gray-100 rounded-lg"></div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Results grid -->
            <div x-show="!isLoading && races.length > 0" x-cloak>
                <p class="text-xs text-gray-500 mb-3">
                    Showing <span class="font-semibold text-gray-700" x-text="races.length"></span> races
                    <span x-show="selectedPreset"
                        x-text="' · ' + (presets.find(p => p.key === selectedPreset) || {}).label"></span>
                </p>
                <div class="grid sm:grid-cols-2 gap-4">
                    <template x-for="race in races" :key="race.raceId">
                        <article class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow p-4 flex flex-col">
                            <div class="flex gap-3">
                                <!-- Logo -->
                                <div class="flex-shrink-0 w-14 h-14 rounded-lg bg-gray-50 border border-gray-100 flex items-center justify-center overflow-hidden">
                                    <template x-if="race.logoUrl">
                                        <img :src="race.logoUrl" :alt="race.name" class="w-full h-full object-contain p-1">
                                    </template>
                                    <template x-if="!race.logoUrl">
                                        <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </template>
                                </div>
                                <!-- Info -->
                                <div class="flex-1 min-w-0">
                                    <h2 class="text-sm font-semibold text-gray-900 leading-snug line-clamp-2" x-text="race.name"></h2>
                                    <p class="text-xs text-gray-500 mt-0.5"
                                        x-text="[race.city, race.state].filter(Boolean).join(', ')"></p>
                                    <p x-show="race.nextDate"
                                        class="text-xs text-blue-600 font-medium mt-0.5"
                                        x-text="formatDate(race.nextDate)"></p>
                                </div>
                            </div>
                            <!-- Action buttons -->
                            <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                                <a :href="race.url" target="_blank" rel="noopener"
                                    class="flex-1 text-center rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    View &amp; Register
                                </a>
                                <button @click="!isTooSoon(race.nextDate) && planThisRace(race)"
                                    :disabled="isTooSoon(race.nextDate)"
                                    :title="isTooSoon(race.nextDate) ? 'Race is less than 4 weeks away — not enough time to train' : ''"
                                    :class="isTooSoon(race.nextDate)
                                        ? 'bg-gray-100 text-gray-400 border border-gray-200 cursor-not-allowed'
                                        : 'bg-blue-600 text-white hover:bg-blue-700 cursor-pointer'"
                                    class="flex-1 rounded-lg px-3 py-1.5 text-xs font-medium transition-colors flex items-center justify-center gap-1">
                                    <svg class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2z" />
                                    </svg>
                                    Plan This Race
                                </button>
                            </div>
                        </article>
                    </template>
                </div>
                <p class="text-xs text-gray-400 text-center mt-6">
                    Race data powered by <a href="https://runsignup.com" target="_blank" rel="noopener"
                        class="text-blue-500 hover:underline font-medium">RunSignup</a>
                </p>
            </div>

            <!-- Empty state after search -->
            <div x-show="!isLoading && hasSearched && races.length === 0 && !error" x-cloak
                class="text-center py-16">
                <div class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-gray-100 mb-4">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <p class="text-sm font-medium text-gray-700">No races found</p>
                <p class="text-xs text-gray-400 mt-1">Try a wider radius, different dates, or remove the distance filter.</p>
            </div>

            <!-- Initial state (before any search) -->
            <div x-show="!isLoading && !hasSearched" class="text-center py-20">
                <div class="inline-flex h-16 w-16 items-center justify-center rounded-2xl bg-blue-50 mb-4">
                    <svg class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <p class="text-sm font-medium text-gray-700">Find your next race</p>
                <p class="text-xs text-gray-400 mt-1">Enter a zip code and click Search Races to get started.</p>
                <p class="text-xs text-gray-400 mt-3 max-w-xs mx-auto">
                    Note: Major branded races (Boston, NYC Marathon, etc.) may not appear —
                    you can enter any race date manually on the
                    <a href="./pyr.html" class="text-blue-500 hover:underline">training plan page</a>.
                </p>
            </div>
        </main>
    </div>
</div>

<script>
function raceFinder() {
    return {
        SF_BASE: 'https://orgfarm-d3a1bb2cb0-dev-ed.develop.my.site.com',

        // Form
        zip: '', radius: 50, startDate: '', endDate: '',
        minDistance: '', maxDistance: '', units: 'K',
        keyword: '', sort: 'next_date_local', selectedPreset: null,

        // Results
        races: [], isLoading: false, hasSearched: false, error: null,

        // AI (commented out — not active)
        // aiQuery: '', aiLoading: false, aiError: null, aiSummary: null,

        // Auth (read-only from localStorage — no sign-in flow on this page)
        jwtToken: null, currentUser: null,

        presets: [
            { key: '5k',           label: '5K'       },
            { key: '10k',          label: '10K'      },
            { key: 'halfMarathon', label: 'Half'     },
            { key: 'marathon',     label: 'Marathon' },
        ],

        // Preset km distance ranges [min, max]
        presetKm: {
            '5k':           [5,    5.2 ],
            '10k':          [10,   10.5],
            'halfMarathon': [20,   22.5],
            'marathon':     [40,   43.5],
        },

        init() {
            const today = new Date();
            const sixMonths = new Date();
            sixMonths.setMonth(sixMonths.getMonth() + 6);
            this.startDate = today.toISOString().slice(0, 10);
            this.endDate   = sixMonths.toISOString().slice(0, 10);

            this.jwtToken = localStorage.getItem('pyr_jwt_token');
            try { this.currentUser = JSON.parse(localStorage.getItem('pyr_user')); } catch(e) {}

            document.getElementById('app-loader')?.remove();
        },

        get isLoggedIn() { return !!this.jwtToken; },

        get userInitial() {
            if (!this.currentUser) return '?';
            return (this.currentUser.name || this.currentUser.email || '?').charAt(0).toUpperCase();
        },

        setPreset(key) {
            this.selectedPreset = key;
            const [min, max] = this.presetKm[key];
            if (this.units === 'M') {
                this.minDistance = (min * 0.621371).toFixed(2);
                this.maxDistance = (max * 0.621371).toFixed(2);
            } else {
                this.minDistance = String(min);
                this.maxDistance = String(max);
            }
        },

        clearPreset() {
            this.selectedPreset = null;
            this.minDistance = '';
            this.maxDistance = '';
        },

        async search() {
            if (!this.zip.trim()) { this.error = 'Please enter a zip code.'; return; }
            this.isLoading   = true;
            this.hasSearched = true;
            this.error       = null;
            this.races       = [];

            try {
                const p = new URLSearchParams({
                    zip:       this.zip.trim(),
                    radius:    this.radius,
                    startDate: this.startDate,
                    endDate:   this.endDate,
                    units:     this.units,
                });
                if (this.minDistance)   p.set('minDistance', this.minDistance);
                if (this.maxDistance)   p.set('maxDistance', this.maxDistance);
                if (this.keyword.trim()) p.set('keyword', this.keyword.trim());
                if (this.sort && this.sort !== 'next_date_local') p.set('sort', this.sort);

                const res  = await fetch(`${this.SF_BASE}/services/apexrest/pyr/races?${p}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Search failed');

                let races = data.races || [];
                if (this.sort === 'next_date_local') {
                    races.sort((a, b) => {
                        if (!a.nextDate && !b.nextDate) return 0;
                        if (!a.nextDate) return 1;
                        if (!b.nextDate) return -1;
                        return new Date(a.nextDate) - new Date(b.nextDate);
                    });
                }
                this.races = races;
            } catch (e) {
                this.error = e.message || 'An error occurred. Please try again.';
            } finally {
                this.isLoading = false;
            }
        },

        /*
        async askAI() {
            if (!this.aiQuery.trim()) {
                this.aiError = "Please describe the race you're looking for.";
                return;
            }
            this.aiLoading = true;
            this.aiError   = null;
            this.aiSummary = null;

            try {
                const token = this.jwtToken;
                const url   = `${this.SF_BASE}/services/apexrest/pyr/races${token ? `?pyr_token=${encodeURIComponent(token)}` : ''}`;
                const res   = await fetch(url, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body:    JSON.stringify({ userPrompt: this.aiQuery.trim() }),
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'AI search failed');

                this.aiSummary = data.summaryText;

                if (data.filtersJson) {
                    try {
                        const f = JSON.parse(data.filtersJson);
                        if (f.zipcode)               this.zip          = f.zipcode;
                        if (f.radiusMiles   != null)  this.radius      = String(f.radiusMiles);
                        if (f.startDate)              this.startDate   = f.startDate;
                        if (f.endDate)                this.endDate     = f.endDate;
                        if (f.minDistanceKm != null)  this.minDistance = String(f.minDistanceKm);
                        if (f.maxDistanceKm != null)  this.maxDistance = String(f.maxDistanceKm);
                        if (f.keywords)               this.keyword     = f.keywords;
                        this.units = 'K';
                        await this.search();
                    } catch (e) { console.error('AI filter parse error', e); }
                }
            } catch (e) {
                this.aiError = e.message || 'AI search failed. Please try again.';
            } finally {
                this.aiLoading = false;
            }
        },
        */

        // Pre-fill pyr.html with race date and distance preset (if selected)
        planThisRace(race) {
            const p = new URLSearchParams();
            if (race.nextDate) {
                // Normalize to YYYY-MM-DD regardless of what RunSignup returns
                const iso = race.nextDate.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
                const d = iso
                    ? new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]))
                    : new Date(race.nextDate);
                if (!isNaN(d)) {
                    const yyyy = d.getFullYear();
                    const mm   = String(d.getMonth() + 1).padStart(2, '0');
                    const dd   = String(d.getDate()).padStart(2, '0');
                    p.set('raceDate', `${yyyy}-${mm}-${dd}`);
                }
            }
            if (this.selectedPreset) p.set('raceDistance', this.selectedPreset);
            // Store params in sessionStorage so pyr.js can read them even if Squarespace
            // Ajax loading runs Alpine init() before history.pushState updates the URL.
            const stored = {};
            if (p.get('raceDate')) stored.raceDate = p.get('raceDate');
            if (p.get('raceDistance')) stored.raceDistance = p.get('raceDistance');
            if (Object.keys(stored).length) sessionStorage.setItem('pyrRaceParams', JSON.stringify(stored));
            window.open(`https://www.planyourrun.org/planner?${p}`, '_top');
        },

        isTooSoon(nextDate) {
            if (!nextDate) return false;
            const iso = nextDate.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
            const raceDate = iso
                ? new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]))
                : new Date(nextDate);
            if (isNaN(raceDate)) return false;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() + 28);
            return raceDate < cutoff;
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            // If YYYY-MM-DD (with or without time), extract date parts to avoid UTC offset shift
            const iso = dateStr.trim().match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (iso) {
                const d = new Date(Number(iso[1]), Number(iso[2]) - 1, Number(iso[3]));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }
            // Fallback: handles MM/DD/YYYY and other browser-parseable formats
            const d = new Date(dateStr);
            if (isNaN(d)) return '';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        },
    };
}
</script>

</body>
</html>
